## Test 18: Memory Leak Check [1 pts]

```

if ! ( which valgrind &> /dev/null ); then
    # "valgrind is not installed. Please install (as root) with:"
    # "pacman -Sy valgrind"
    test_end 1
fi

leak_output=$(timeout 10 valgrind \
    --trace-children=no \
    --child-silent-after-fork=yes \
    --leak-check=full \
    --track-fds=yes \
    --show-leak-kinds=all \
    --track-origins=yes \
    ./$SHELL_NAME < <(echo "${script}") 2>&1)

echo "${leak_output}"
==1357750== Memcheck, a memory error detector
==1357750== Copyright (C) 2002-2017, and GNU GPL'd, by Julian Seward et al.
==1357750== Using Valgrind-3.16.1 and LibVEX; rerun with -h for copyright info
==1357750== Command: ./crash
==1357750== 
ui.c:44:init_ui(): Initializing UI...
ui.c:47:init_ui(): Setting locale: en_US.UTF-8
ui.c:52:init_ui(): Entering scripting mode
elist.c:43:elist_create(): Initializing new elist: capacity = [10], item_sz=[8], bytes[80]
elist.c:43:elist_create(): Initializing new elist: capacity = [10], item_sz=[260], bytes[2600]
==1357750== Invalid read of size 8
==1357750==    at 0x484555F: memmove (vg_replace_strmem.c:1270)
==1357750==    by 0x49F7348: clist_add (clist.c:61)
==1357750==    by 0x10A531: hist_add (history.c:37)
==1357750==    by 0x10A948: process_command (shell.c:91)
==1357750==    by 0x10BC7C: main (shell.c:370)
==1357750==  Address 0x4c478e8 is 3 bytes after a block of size 5 alloc'd
==1357750==    at 0x483E77F: malloc (vg_replace_malloc.c:307)
==1357750==    by 0x4A8C5BE: strdup (in /usr/lib/libc-2.33.so)
==1357750==    by 0x10A514: hist_add (history.c:36)
==1357750==    by 0x10A948: process_command (shell.c:91)
==1357750==    by 0x10BC7C: main (shell.c:370)
==1357750== 
==1357750== Invalid read of size 8
==1357750==    at 0x4845567: memmove (vg_replace_strmem.c:1270)
==1357750==    by 0x49F7348: clist_add (clist.c:61)
==1357750==    by 0x10A531: hist_add (history.c:37)
==1357750==    by 0x10A948: process_command (shell.c:91)
==1357750==    by 0x10BC7C: main (shell.c:370)
==1357750==  Address 0x4c478f0 is 11 bytes after a block of size 5 alloc'd
==1357750==    at 0x483E77F: malloc (vg_replace_malloc.c:307)
==1357750==    by 0x4A8C5BE: strdup (in /usr/lib/libc-2.33.so)
==1357750==    by 0x10A514: hist_add (history.c:36)
==1357750==    by 0x10A948: process_command (shell.c:91)
==1357750==    by 0x10BC7C: main (shell.c:370)
==1357750== 
==1357750== Invalid read of size 8
==1357750==    at 0x484556F: memmove (vg_replace_strmem.c:1270)
==1357750==    by 0x49F7348: clist_add (clist.c:61)
==1357750==    by 0x10A531: hist_add (history.c:37)
==1357750==    by 0x10A948: process_command (shell.c:91)
==1357750==    by 0x10BC7C: main (shell.c:370)
==1357750==  Address 0x4c478f8 is 19 bytes after a block of size 5 alloc'd
==1357750==    at 0x483E77F: malloc (vg_replace_malloc.c:307)
==1357750==    by 0x4A8C5BE: strdup (in /usr/lib/libc-2.33.so)
==1357750==    by 0x10A514: hist_add (history.c:36)
==1357750==    by 0x10A948: process_command (shell.c:91)
==1357750==    by 0x10BC7C: main (shell.c:370)
==1357750== 
==1357750== Invalid read of size 8
==1357750==    at 0x4845554: memmove (vg_replace_strmem.c:1270)
==1357750==    by 0x49F7348: clist_add (clist.c:61)
==1357750==    by 0x10A531: hist_add (history.c:37)
==1357750==    by 0x10A948: process_command (shell.c:91)
==1357750==    by 0x10BC7C: main (shell.c:370)
==1357750==  Address 0x4c47900 is 16 bytes after a block of size 16 in arena "client"
==1357750== 
shell.c:94:process_command(): Input command: ls /
shell.c:95:process_command(): list size: 0
shell.c:114:process_command(): Input command after: ls
shell.c:120:process_command(): Processed 3 tokens
shell.c:261:process_command(): counter: 0
shell.c:262:process_command(): BUILTINCMDCHAR: ls
shell.c:261:process_command(): counter: 1
shell.c:262:process_command(): BUILTINCMDCHAR: /
shell.c:284:process_command(): stdout fileno 1
bin
boot
dev
etc
home
lib
lib64
mnt
opt
proc
repos
root
run
sbin
srv
sys
tmp
usr
var
vm-status
ui.c:154:set_status(): status: 0
shell.c:317:process_command(): 0
ui.c:154:set_status(): status: 0
shell.c:94:process_command(): Input command: !1
shell.c:95:process_command(): list size: 0
shell.c:114:process_command(): Input command after: !1
shell.c:120:process_command(): Processed 2 tokens
shell.c:94:process_command(): Input command: ls /
shell.c:95:process_command(): list size: 2
shell.c:114:process_command(): Input command after: ls
shell.c:120:process_command(): Processed 3 tokens
shell.c:261:process_command(): counter: 0
shell.c:262:process_command(): BUILTINCMDCHAR: ls
shell.c:261:process_command(): counter: 1
shell.c:262:process_command(): BUILTINCMDCHAR: /
shell.c:284:process_command(): stdout fileno 1
bin
boot
dev
etc
home
lib
lib64
mnt
opt
proc
repos
root
run
sbin
srv
sys
tmp
usr
var
vm-status
ui.c:154:set_status(): status: 0
shell.c:317:process_command(): 0
ui.c:154:set_status(): status: 0
ui.c:154:set_status(): status: 0
shell.c:94:process_command(): Input command: 
shell.c:95:process_command(): list size: 0
shell.c:114:process_command(): Input command after: 
shell.c:120:process_command(): Processed 1 tokens
shell.c:123:process_command(): Empty command
shell.c:284:process_command(): stdout fileno 1
ui.c:154:set_status(): status: 139
shell.c:317:process_command(): 139
ui.c:154:set_status(): status: 139
shell.c:94:process_command(): Input command: 
shell.c:95:process_command(): list size: 0
shell.c:114:process_command(): Input command after: 
shell.c:120:process_command(): Processed 1 tokens
shell.c:123:process_command(): Empty command
shell.c:284:process_command(): stdout fileno 1
ui.c:154:set_status(): status: 139
shell.c:317:process_command(): 139
ui.c:154:set_status(): status: 139
shell.c:94:process_command(): Input command: jobs
shell.c:95:process_command(): list size: 0
shell.c:114:process_command(): Input command after: jobs
shell.c:120:process_command(): Processed 2 tokens
ui.c:154:set_status(): status: 0
shell.c:261:process_command(): counter: 0
shell.c:262:process_command(): BUILTINCMDCHAR: jobs
shell.c:284:process_command(): stdout fileno 1
ui.c:154:set_status(): status: 0
shell.c:94:process_command(): Input command: cd
shell.c:95:process_command(): list size: 2
shell.c:114:process_command(): Input command after: cd
shell.c:120:process_command(): Processed 2 tokens
ui.c:154:set_status(): status: 0
shell.c:261:process_command(): counter: 0
shell.c:262:process_command(): BUILTINCMDCHAR: cd
shell.c:284:process_command(): stdout fileno 1
ui.c:154:set_status(): status: 0
shell.c:94:process_command(): Input command: ls / # Doing some more lsing
shell.c:95:process_command(): list size: 2
shell.c:114:process_command(): Input command after: ls
shell.c:120:process_command(): Processed 3 tokens
shell.c:261:process_command(): counter: 0
shell.c:262:process_command(): BUILTINCMDCHAR: ls
shell.c:261:process_command(): counter: 1
shell.c:262:process_command(): BUILTINCMDCHAR: /
shell.c:284:process_command(): stdout fileno 1
bin
boot
dev
etc
home
lib
lib64
mnt
opt
proc
repos
root
run
sbin
srv
sys
tmp
usr
var
vm-status
ui.c:154:set_status(): status: 0
shell.c:317:process_command(): 0
ui.c:154:set_status(): status: 0
shell.c:94:process_command(): Input command: !!
shell.c:95:process_command(): list size: 0
shell.c:114:process_command(): Input command after: !!
shell.c:120:process_command(): Processed 2 tokens
shell.c:94:process_command(): Input command: ls / # Doing some more lsing
shell.c:95:process_command(): list size: 2
shell.c:114:process_command(): Input command after: ls
shell.c:120:process_command(): Processed 3 tokens
shell.c:261:process_command(): counter: 0
shell.c:262:process_command(): BUILTINCMDCHAR: ls
shell.c:261:process_command(): counter: 1
shell.c:262:process_command(): BUILTINCMDCHAR: /
shell.c:284:process_command(): stdout fileno 1
bin
boot
dev
etc
home
lib
lib64
mnt
opt
proc
repos
root
run
sbin
srv
sys
tmp
usr
var
vm-status
ui.c:154:set_status(): status: 0
shell.c:317:process_command(): 0
ui.c:154:set_status(): status: 0
ui.c:154:set_status(): status: 0
shell.c:94:process_command(): Input command: asdfghjklqprewopiqwualasdf # Bad Command!
shell.c:95:process_command(): list size: 0
shell.c:114:process_command(): Input command after: asdfghjklqprewopiqwualasdf
shell.c:120:process_command(): Processed 2 tokens
shell.c:261:process_command(): counter: 0
shell.c:262:process_command(): BUILTINCMDCHAR: asdfghjklqprewopiqwualasdf
shell.c:284:process_command(): stdout fileno 1
execvp: No such file or directory
ui.c:154:set_status(): status: 256
shell.c:317:process_command(): 256
ui.c:154:set_status(): status: 256
shell.c:94:process_command(): Input command: # Comment only
shell.c:95:process_command(): list size: 0
shell.c:114:process_command(): Input command after: #
shell.c:120:process_command(): Processed 1 tokens
shell.c:123:process_command(): Empty command
shell.c:284:process_command(): stdout fileno 1
ui.c:154:set_status(): status: 139
shell.c:317:process_command(): 139
ui.c:154:set_status(): status: 139
shell.c:94:process_command(): Input command: pwd
shell.c:95:process_command(): list size: 0
shell.c:114:process_command(): Input command after: pwd
shell.c:120:process_command(): Processed 2 tokens
shell.c:261:process_command(): counter: 0
shell.c:262:process_command(): BUILTINCMDCHAR: pwd
shell.c:284:process_command(): stdout fileno 1
/home/mmalensek
ui.c:154:set_status(): status: 0
shell.c:317:process_command(): 0
ui.c:154:set_status(): status: 0
shell.c:94:process_command(): Input command: echo hi
shell.c:95:process_command(): list size: 0
shell.c:114:process_command(): Input command after: echo
shell.c:120:process_command(): Processed 3 tokens
shell.c:261:process_command(): counter: 0
shell.c:262:process_command(): BUILTINCMDCHAR: echo
shell.c:261:process_command(): counter: 1
shell.c:262:process_command(): BUILTINCMDCHAR: hi
shell.c:284:process_command(): stdout fileno 1
hi
ui.c:154:set_status(): status: 0
shell.c:317:process_command(): 0
ui.c:154:set_status(): status: 0
shell.c:94:process_command(): Input command: sort -r -n < /etc/passwd > /tmp/24840
shell.c:95:process_command(): list size: 0
shell.c:114:process_command(): Input command after: sort
shell.c:120:process_command(): Processed 8 tokens
shell.c:261:process_command(): counter: 0
shell.c:262:process_command(): BUILTINCMDCHAR: sort
shell.c:261:process_command(): counter: 1
shell.c:262:process_command(): BUILTINCMDCHAR: -r
shell.c:261:process_command(): counter: 2
shell.c:262:process_command(): BUILTINCMDCHAR: -n
shell.c:261:process_command(): counter: 3
shell.c:262:process_command(): BUILTINCMDCHAR: <
shell.c:261:process_command(): counter: 4
shell.c:262:process_command(): BUILTINCMDCHAR: /etc/passwd
shell.c:261:process_command(): counter: 5
shell.c:262:process_command(): BUILTINCMDCHAR: >
shell.c:264:process_command(): filename: /tmp/24840
shell.c:261:process_command(): counter: 6
shell.c:262:process_command(): BUILTINCMDCHAR: /tmp/24840
shell.c:284:process_command(): stdout fileno 1
ui.c:154:set_status(): status: 0
shell.c:317:process_command(): 0
ui.c:154:set_status(): status: 0
shell.c:94:process_command(): Input command: rm /tmp/24840
shell.c:95:process_command(): list size: 0
shell.c:114:process_command(): Input command after: rm
shell.c:120:process_command(): Processed 3 tokens
shell.c:261:process_command(): counter: 0
shell.c:262:process_command(): BUILTINCMDCHAR: rm
shell.c:261:process_command(): counter: 1
shell.c:262:process_command(): BUILTINCMDCHAR: /tmp/24840
shell.c:284:process_command(): stdout fileno 1
ui.c:154:set_status(): status: 0
shell.c:317:process_command(): 0
ui.c:154:set_status(): status: 0
shell.c:94:process_command(): Input command: history
shell.c:95:process_command(): list size: 0
shell.c:114:process_command(): Input command after: history
shell.c:120:process_command(): Processed 2 tokens
1 ls /
2 ls /
3 jobs
4 cd
5 ls / # Doing some more lsing
6 ls / # Doing some more lsing
7 asdfghjklqprewopiqwualasdf # Bad Command!
8 # Comment only
9 pwd
10 echo hi
11 sort -r -n < /etc/passwd > /tmp/24840
12 rm /tmp/24840
13 history
ui.c:154:set_status(): status: 0
shell.c:261:process_command(): counter: 0
shell.c:262:process_command(): BUILTINCMDCHAR: history
shell.c:284:process_command(): stdout fileno 1
ui.c:154:set_status(): status: 0
shell.c:94:process_command(): Input command: !p
shell.c:95:process_command(): list size: 2
shell.c:114:process_command(): Input command after: !p
shell.c:120:process_command(): Processed 2 tokens
shell.c:94:process_command(): Input command: pwd
shell.c:95:process_command(): list size: 2
shell.c:114:process_command(): Input command after: pwd
shell.c:120:process_command(): Processed 2 tokens
shell.c:261:process_command(): counter: 0
shell.c:262:process_command(): BUILTINCMDCHAR: pwd
shell.c:284:process_command(): stdout fileno 1
/home/mmalensek
ui.c:154:set_status(): status: 0
shell.c:317:process_command(): 0
ui.c:154:set_status(): status: 0
ui.c:154:set_status(): status: 0
shell.c:94:process_command(): Input command: 
shell.c:95:process_command(): list size: 0
shell.c:114:process_command(): Input command after: 
shell.c:120:process_command(): Processed 1 tokens
shell.c:123:process_command(): Empty command
shell.c:284:process_command(): stdout fileno 1
ui.c:154:set_status(): status: 139
shell.c:317:process_command(): 139
ui.c:154:set_status(): status: 139
shell.c:94:process_command(): Input command: 
shell.c:95:process_command(): list size: 0
shell.c:114:process_command(): Input command after: 
shell.c:120:process_command(): Processed 1 tokens
shell.c:123:process_command(): Empty command
shell.c:284:process_command(): stdout fileno 1
ui.c:154:set_status(): status: 139
shell.c:317:process_command(): 139
ui.c:154:set_status(): status: 139
shell.c:94:process_command(): Input command: echo bye
shell.c:95:process_command(): list size: 0
shell.c:114:process_command(): Input command after: echo
shell.c:120:process_command(): Processed 3 tokens
shell.c:261:process_command(): counter: 0
shell.c:262:process_command(): BUILTINCMDCHAR: echo
shell.c:261:process_command(): counter: 1
shell.c:262:process_command(): BUILTINCMDCHAR: bye
shell.c:284:process_command(): stdout fileno 1
bye
ui.c:154:set_status(): status: 0
shell.c:317:process_command(): 0
ui.c:154:set_status(): status: 0
getline: Inappropriate ioctl for device
==1357750== 
==1357750== FILE DESCRIPTORS: 4 open at exit.
==1357750== Open file descriptor 63:
==1357750==    <inherited from parent>
==1357750== 
==1357750== Open file descriptor 2:
==1357750==    <inherited from parent>
==1357750== 
==1357750== Open file descriptor 1:
==1357750==    <inherited from parent>
==1357750== 
==1357750== Open file descriptor 0:
==1357750==    <inherited from parent>
==1357750== 
==1357750== 
==1357750== HEAP SUMMARY:
==1357750==     in use at exit: 120 bytes in 1 blocks
==1357750==   total heap usage: 266 allocs, 265 frees, 77,899 bytes allocated
==1357750== 
==1357750== 120 bytes in 1 blocks are definitely lost in loss record 1 of 1
==1357750==    at 0x483E77F: malloc (vg_replace_malloc.c:307)
==1357750==    by 0x4A72E03: getdelim (in /usr/lib/libc-2.33.so)
==1357750==    by 0x10C2D7: read_command (ui.c:182)
==1357750==    by 0x10BC5E: main (shell.c:366)
==1357750== 
==1357750== LEAK SUMMARY:
==1357750==    definitely lost: 120 bytes in 1 blocks
==1357750==    indirectly lost: 0 bytes in 0 blocks
==1357750==      possibly lost: 0 bytes in 0 blocks
==1357750==    still reachable: 0 bytes in 0 blocks
==1357750==         suppressed: 0 bytes in 0 blocks
==1357750== 
==1357750== For lists of detected and suppressed errors, rerun with: -s
==1357750== ERROR SUMMARY: 448 errors from 5 contexts (suppressed: 0 from 0)

# Check for open FDs
awk "${fd_check}" <<< "${leak_output}" \
    | grep -i '==[0-9]*==.*file descriptor' && test_end 1

# Make sure there were no leaks possible
grep -i '==[0-9]*==.*no leaks are possible' \
    <<< "${leak_output}" || test_end 1
 --> Test failed (1)
```

